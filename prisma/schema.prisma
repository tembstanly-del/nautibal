// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// PRODUCT MANAGEMENT
// ============================================

model Product {
  id          String   @id @default(cuid())
  name        String
  aliases     String[] @default([]) // Alternative names for flexible matching
  description String?
  sku         String?  @unique // Stock keeping unit
  price       Decimal  @db.Decimal(10, 2)
  unit        String   @default("unit") // unit, pack, box, carton, etc.
  category    String?

  // Stock management
  stockQuantity   Int     @default(0)
  minStockLevel   Int     @default(10) // Low stock alert threshold
  reorderQuantity Int     @default(50) // Suggested reorder amount

  // Metadata
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  quoteItems      QuoteItem[]
  invoiceItems    InvoiceItem[]
  stockMovements  StockMovement[]

  @@index([name])
  @@index([category])
  @@index([isActive])
}

// ============================================
// CLIENT MANAGEMENT
// ============================================

model Client {
  id            String   @id @default(cuid())
  name          String
  email         String?
  phone         String?
  address       String?
  city          String?
  country       String   @default("Ghana")

  // Billing information
  billingAddress String?
  vatNumber      String?
  paymentTerms   Int      @default(30) // Days
  creditLimit    Decimal? @db.Decimal(12, 2)

  // Contact person
  contactName    String?
  contactEmail   String?
  contactPhone   String?

  // Classification
  clientType     ClientType @default(REGULAR)
  notes          String?

  // Metadata
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  quotes      Quote[]
  invoices    Invoice[]

  @@index([name])
  @@index([email])
  @@index([isActive])
}

enum ClientType {
  REGULAR
  VIP
  GOVERNMENT
  HOSPITAL
  PHARMACY
  DISTRIBUTOR
}

// ============================================
// QUOTATION MANAGEMENT
// ============================================

model Quote {
  id            String      @id @default(cuid())
  quoteNumber   String      @unique // e.g., QT-2025-0001

  // Client reference
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id])

  // Quote details
  status        QuoteStatus @default(DRAFT)
  issueDate     DateTime    @default(now())
  validUntil    DateTime    // Expiry date

  // Amounts (calculated from items)
  subtotal      Decimal     @db.Decimal(12, 2) @default(0)
  taxRate       Decimal     @db.Decimal(5, 2) @default(0) // Percentage
  taxAmount     Decimal     @db.Decimal(12, 2) @default(0)
  discount      Decimal     @db.Decimal(12, 2) @default(0)
  total         Decimal     @db.Decimal(12, 2) @default(0)

  // Additional info
  notes         String?     // Internal notes
  terms         String?     // Terms and conditions

  // Conversion tracking
  convertedToInvoiceId String?

  // Metadata
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  items         QuoteItem[]
  invoices      Invoice[]   // Can create multiple invoices (partial conversion)

  @@index([clientId])
  @@index([status])
  @@index([issueDate])
  @@index([quoteNumber])
}

enum QuoteStatus {
  DRAFT       // Being prepared
  SENT        // Sent to client
  APPROVED    // Client approved
  PARTIAL     // Partially converted to invoice
  CONVERTED   // Fully converted to invoice
  REJECTED    // Client rejected
  EXPIRED     // Past valid date
}

model QuoteItem {
  id            String   @id @default(cuid())

  // Parent quote
  quoteId       String
  quote         Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // Product reference
  productId     String
  product       Product  @relation(fields: [productId], references: [id])

  // Item details (snapshot at time of quote)
  productName   String   // Snapshot of product name
  description   String?
  quantity      Int
  unit          String   @default("unit")
  unitPrice     Decimal  @db.Decimal(10, 2)
  discount      Decimal  @db.Decimal(10, 2) @default(0)
  total         Decimal  @db.Decimal(12, 2)

  // Conversion tracking
  quantityConverted Int   @default(0) // How much has been converted to invoice

  // Metadata
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([quoteId])
  @@index([productId])
}

// ============================================
// INVOICE MANAGEMENT
// ============================================

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique // e.g., INV-2025-0001

  // Client reference
  clientId        String
  client          Client        @relation(fields: [clientId], references: [id])

  // Source quote (if converted from quote)
  quoteId         String?
  quote           Quote?        @relation(fields: [quoteId], references: [id])

  // Invoice details
  status          InvoiceStatus @default(DRAFT)
  issueDate       DateTime      @default(now())
  dueDate         DateTime

  // Amounts
  subtotal        Decimal       @db.Decimal(12, 2) @default(0)
  taxRate         Decimal       @db.Decimal(5, 2) @default(0)
  taxAmount       Decimal       @db.Decimal(12, 2) @default(0)
  discount        Decimal       @db.Decimal(12, 2) @default(0)
  total           Decimal       @db.Decimal(12, 2) @default(0)
  amountPaid      Decimal       @db.Decimal(12, 2) @default(0)
  balanceDue      Decimal       @db.Decimal(12, 2) @default(0)

  // Additional info
  notes           String?
  terms           String?

  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  items           InvoiceItem[]
  payments        Payment[]
  stockMovements  StockMovement[]

  @@index([clientId])
  @@index([quoteId])
  @@index([status])
  @@index([issueDate])
  @@index([dueDate])
  @@index([invoiceNumber])
}

enum InvoiceStatus {
  DRAFT       // Being prepared
  SENT        // Sent to client
  PAID        // Fully paid
  PARTIAL     // Partially paid
  OVERDUE     // Past due date, not fully paid
  CANCELLED   // Cancelled/voided
}

model InvoiceItem {
  id            String   @id @default(cuid())

  // Parent invoice
  invoiceId     String
  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Product reference
  productId     String
  product       Product  @relation(fields: [productId], references: [id])

  // Item details (snapshot at time of invoice)
  productName   String
  description   String?
  quantity      Int
  unit          String   @default("unit")
  unitPrice     Decimal  @db.Decimal(10, 2)
  discount      Decimal  @db.Decimal(10, 2) @default(0)
  total         Decimal  @db.Decimal(12, 2)

  // Metadata
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([invoiceId])
  @@index([productId])
}

// ============================================
// PAYMENT TRACKING
// ============================================

model Payment {
  id            String        @id @default(cuid())

  // Invoice reference
  invoiceId     String
  invoice       Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Payment details
  amount        Decimal       @db.Decimal(12, 2)
  paymentDate   DateTime      @default(now())
  paymentMethod PaymentMethod @default(BANK_TRANSFER)
  reference     String?       // Bank reference, cheque number, etc.
  notes         String?

  // Metadata
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([invoiceId])
  @@index([paymentDate])
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  MOBILE_MONEY
  CARD
  OTHER
}

// ============================================
// STOCK/INVENTORY MANAGEMENT
// ============================================

model StockMovement {
  id            String        @id @default(cuid())

  // Product reference
  productId     String
  product       Product       @relation(fields: [productId], references: [id])

  // Movement details
  type          MovementType
  quantity      Int           // Positive for IN, negative for OUT
  previousStock Int           // Stock before movement
  newStock      Int           // Stock after movement

  // Reference (what caused the movement)
  invoiceId     String?
  invoice       Invoice?      @relation(fields: [invoiceId], references: [id])
  reference     String?       // Additional reference info
  notes         String?

  // Metadata
  createdAt     DateTime      @default(now())

  @@index([productId])
  @@index([invoiceId])
  @@index([type])
  @@index([createdAt])
}

enum MovementType {
  INITIAL     // Initial stock entry
  PURCHASE    // Stock received from supplier
  ADJUSTMENT  // Manual adjustment (correction)
  INVOICE     // Stock out for invoice
  RETURN      // Stock returned by customer
  DAMAGED     // Stock written off (damaged)
  TRANSFER    // Transfer between locations (future use)
}

// ============================================
// APPLICATION SETTINGS
// ============================================

model Settings {
  id            String   @id @default("default")

  // Company Information
  companyName   String   @default("Medizam Healthcare Limited")
  companyAddress String?
  companyPhone  String?
  companyEmail  String?
  companyLogo   String?  // URL or base64

  // Tax Settings
  defaultTaxRate    Decimal @db.Decimal(5, 2) @default(0)
  taxRegistrationNo String?

  // Document Numbering
  quotePrefix       String  @default("QT")
  quoteNextNumber   Int     @default(1)
  invoicePrefix     String  @default("INV")
  invoiceNextNumber Int     @default(1)

  // Default Terms
  defaultPaymentTerms Int     @default(30)
  defaultQuoteValidity Int    @default(14) // Days
  defaultQuoteTerms   String?
  defaultInvoiceTerms String?

  // Low Stock Alert
  lowStockAlertEnabled Boolean @default(true)

  // Currency
  currency      String   @default("GHS")
  currencySymbol String  @default("GHâ‚µ")

  // Metadata
  updatedAt     DateTime @updatedAt
}
